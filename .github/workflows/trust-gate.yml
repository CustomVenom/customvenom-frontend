name: trust-gate
on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: trust-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      # 0) Secrets preflight (names the missing ones and stops)
      - name: Secrets preflight
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        shell: bash
        run: |
          set -euo pipefail
          req=(NOTION_TOKEN NOTION_PAGE_ID NOTION_DATABASE_ID)
          ok=1
          for k in "${req[@]}"; do
            [ -n "${!k:-}" ] || { echo "::error ::Missing secret $k"; ok=0; }
          done
          [ $ok -eq 1 ] || exit 1
          echo "DB(last6)=$(echo "$NOTION_DATABASE_ID" | tail -c 7)"
          echo "PAGE(last6)=$(echo "$NOTION_PAGE_ID" | tail -c 7)"
          echo "TOKEN(prefix)=$(printf '%s' "$NOTION_TOKEN" | cut -c1-8)********"

      # 1) Notion token sanity (proves this run has a valid integration token)
      - name: Notion whoami
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          who="$(curl -sS https://api.notion.com/v1/users/me \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Notion-Version: 2022-06-28")"
          echo "$who" | jq -e '.object=="user"' >/dev/null || { echo "$who"; exit 1; }

      # 2) DB access probe (proves correct DB + sharing for THIS token)
      - name: Notion DB access probe
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        shell: bash
        run: |
          set -euo pipefail
          resp="$(curl -sS -w '\n%{http_code}' "https://api.notion.com/v1/databases/${NOTION_DATABASE_ID}/query" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{}')"
          body="$(sed '$d' <<<"$resp")"; code="$(tail -n1 <<<"$resp")"
          [ "$code" = 200 ] || { echo "DB probe failed: HTTP $code"; echo "$body"; exit 1; }

      # 3) Minimal build/lint check (frontend/data-pipelines only - skip for workers-api)
      - name: Basic validation
        if: github.repository != 'CustomVenom/customvenom-workers-api'
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "package.json" ]; then
            echo "Node project detected - running basic checks"
            npm ci || npm i
            npm run typecheck --if-present || echo "No typecheck script"
          elif [ -f "requirements.txt" ]; then
            echo "Python project detected - running basic checks"
            pip install -r requirements.txt
            python -m py_compile src/**/*.py 2>/dev/null || echo "Python syntax OK"
          fi

